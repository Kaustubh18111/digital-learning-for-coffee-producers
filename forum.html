<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forum • CoffeeLearn</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .posts { list-style: none; padding: 0; display: grid; gap: 0.75rem; }
    .post-item { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.9rem; box-shadow: var(--shadow); }
    .post-item h4 { margin: 0 0 .25rem; font-size: 1rem; }
    .post-item .meta { font-size: .75rem; color: var(--muted); }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  <main class="container">
    <section class="panel">
      <h2>IndiaCoffee Reddit</h2>
      <p class="muted">Top posts from <a href="https://www.reddit.com/r/IndiaCoffee/" target="_blank" rel="noopener">r/IndiaCoffee</a>. We only show titles and metadata here.</p>
      <ul class="posts" id="reddit-posts"></ul>
    </section>
  </main>
  <div id="footer-placeholder"></div>
  <script type="module" src="js/firebase-init.js"></script>
  <script type="module" src="js/main.js"></script>
  <script type="module">
    const list = document.getElementById('reddit-posts');
    const BASE = 'https://www.reddit.com/r/IndiaCoffee/.json?limit=12';
    const SOURCES = [
      BASE,
      'https://cors.isomorphic-git.org/' + BASE,
      'https://api.allorigins.win/raw?url=' + encodeURIComponent(BASE),
      'https://corsproxy.io/?' + encodeURIComponent(BASE)
    ];

    async function fetchWithFallback(urls) {
      let lastError;
      for (const u of urls) {
        try {
          const res = await fetch(u, { cache: 'no-store' });
          if (!res.ok) { lastError = new Error('HTTP ' + res.status); continue; }
          const data = await res.json();
          return data;
        } catch (e) {
          lastError = e;
        }
      }
      throw lastError || new Error('All fetch attempts failed');
    }

    async function renderReddit() {
      if (!list) return;
      list.innerHTML = '<li class="post-item">Loading Reddit posts...</li>';
      try {
        const data = await fetchWithFallback(SOURCES);
        const items = (data && data.data && Array.isArray(data.data.children)) ? data.data.children : [];
        if (items.length === 0) {
          list.innerHTML = '<li class="post-item">No Reddit posts found.</li>';
          return;
        }
        list.innerHTML = '';
        for (const child of items) {
          const p = child && child.data ? child.data : null;
          if (!p) continue;
          const url = p.url_overridden_by_dest || ('https://www.reddit.com' + p.permalink);
          const li = document.createElement('li');
          li.className = 'post-item';
          li.innerHTML = `
            <h4><a href="${url}" target="_blank" rel="noopener">${p.title || 'Untitled Reddit Post'}</a></h4>
            <div class="meta">by u/${p.author} • r/${p.subreddit} • ${p.ups} upvotes</div>
          `;
          list.appendChild(li);
        }
      } catch (e) {
        console.error('Error loading Reddit', e);
        list.innerHTML = `
          <li class="post-item">
            Could not load Reddit posts due to CORS. 
            <a href="https://www.reddit.com/r/IndiaCoffee/" target="_blank" rel="noopener">Open r/IndiaCoffee on Reddit</a>.
          </li>`;
      }
    }
    renderReddit();
  </script>
</body>
</html>
